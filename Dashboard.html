<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>GARMOTOR - Gest√£o de Stock</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7fe; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 20px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        label { font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; color: #555; text-transform: uppercase; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: #0084ff; box-shadow: 0 0 0 3px rgba(0,132,255,0.1); }
        
        .photo-section { background: #f9fbff; padding: 20px; border-radius: 15px; border: 2px dashed #0084ff; margin-top: 10px; text-align: center; }
        #previewFotos { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; justify-content: center; }
        .foto-box { position: relative; width: 140px; height: 100px; border: 2px solid transparent; transition: 0.3s; }
        .foto-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
        .btn-del { position: absolute; top: -10px; right: -10px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold; }

        .btn-publicar { width: 100%; background: #0084ff; color: white; border: none; padding: 18px; border-radius: 15px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 20px; }
        .btn-publicar:hover { background: #0066cc; transform: translateY(-2px); }
        .btn-publicar:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Novo An√∫ncio</h1>
            <p>Vendedor: <span id="nomeVendedor" style="font-weight: bold; color: #0084ff;">...</span></p>
        </div>
        <button onclick="location.href='Index.html'" style="background:none; border:none; color:#666; cursor:pointer; font-weight:700;">Voltar ao Site</button>
    </header>

    <div class="form-grid">
        <div class="form-group">
            <label>Marca</label>
            <select id="marca" onchange="atualizarModelos()">
                <option value="" disabled selected hidden>Escolha uma Marca...</option>
                <option value="BMW">BMW</option>
                <option value="Mercedes-Benz">Mercedes-Benz</option>
                <option value="Audi">Audi</option>
                <option value="Volkswagen">Volkswagen</option>
                <option value="Renault">Renault</option>
                <option value="Peugeot">Peugeot</option>
                <option value="Tesla">Tesla</option>
                <option value="Toyota">Toyota</option>
            </select>
        </div>

        <div class="form-group">
            <label>Modelo</label>
            <select id="modelo" disabled>
                <option value="">Aguardando marca...</option>
            </select>
        </div>

        <div class="form-group"><label>Ano (1900-2026)</label><input type="number" id="ano" placeholder="2022"></div>
        <div class="form-group"><label>Quil√≥metros (Km)</label><input type="number" id="kms" placeholder="25000"></div>
        <div class="form-group"><label>Pre√ßo (‚Ç¨)</label><input type="number" id="preco" placeholder="50000"></div>
        
        <div class="form-group">
            <label>Combust√≠vel</label>
            <select id="combustivel">
                <option>Diesel</option>
                <option>Gasolina</option>
                <option>H√≠brido</option>
                <option>El√©trico</option>
            </select>
        </div>

        <div class="form-group">
            <label>Caixa</label>
            <select id="caixa">
                <option>Manual</option>
                <option>Autom√°tica</option>
            </select>
        </div>

        <div class="form-group"><label>Cor</label><input type="text" id="cor" placeholder="Preto"></div>
    </div>

    <div class="photo-section">
        <label style="cursor: pointer; display: block; padding: 10px;">
            <strong>üì∑ ADICIONAR FOTOS (CLIQUE AQUI)</strong>
            <input type="file" id="fotoInput" multiple accept="image/*" style="display:none;" onchange="gerirFotos(this)">
        </label>
        <div id="previewFotos"></div>
    </div>

    <button id="btnPublicar" class="btn-publicar" onclick="enviarAnuncio()">PUBLICAR NO STOCK</button>
</div>

<script>
    let listaImagens = [];
    let fotoPrincipalIndex = 0;

    const baseDadosModelos = {
        "BMW": ["S√©rie 1", "S√©rie 3", "S√©rie 5", "X1", "X3", "X5", "M3", "M4"],
        "Mercedes-Benz": ["Classe A", "Classe C", "Classe E", "CLA", "GLA", "GLC", "EQE"],
        "Audi": ["A1", "A3", "A4", "A6", "Q3", "Q5", "e-tron"],
        "Volkswagen": ["Golf", "Polo", "Passat", "Tiguan", "T-Roc", "ID.3", "ID.4"],
        "Renault": ["Clio", "Megane", "Captur", "Zoe", "Austral"],
        "Peugeot": ["208", "308", "2008", "3008", "5008"],
        "Tesla": ["Model 3", "Model Y", "Model S", "Model X"],
        "Toyota": ["Yaris", "Corolla", "C-HR", "RAV4", "Hilux"]
    };

    window.onload = () => {
        const nome = localStorage.getItem('vendedorNome');
        if (!nome) {
            alert("Sess√£o expirada. A redirecionar para Login...");
            window.location.href = 'Authentication.html';
            return;
        }
        document.getElementById('nomeVendedor').innerText = nome;
    };

    function atualizarModelos() {
        const marcaSelecionada = document.getElementById('marca').value;
        const selectModelo = document.getElementById('modelo');
        selectModelo.innerHTML = '';

        if (marcaSelecionada && baseDadosModelos[marcaSelecionada]) {
            selectModelo.disabled = false;
            const opInicial = document.createElement('option');
            opInicial.text = "Selecione o Modelo";
            opInicial.value = "";
            opInicial.disabled = true;
            opInicial.selected = true;
            selectModelo.appendChild(opInicial);

            baseDadosModelos[marcaSelecionada].forEach(modelo => {
                const option = document.createElement('option');
                option.value = modelo;
                option.text = modelo;
                selectModelo.appendChild(option);
            });
        }
    }

    async function gerirFotos(input) {
        if (!input.files || input.files.length === 0) return;
        const files = Array.from(input.files);
        for (let file of files) {
            const base64 = await comprimirImagem(file);
            listaImagens.push(base64);
        }
        renderizarGaleria();
        input.value = ""; 
    }

    function renderizarGaleria() {
        const preview = document.getElementById('previewFotos');
        preview.innerHTML = ""; 
        listaImagens.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = 'foto-box';
            if(index === fotoPrincipalIndex) div.style.border = "3px solid #ffbb00";
            
            div.innerHTML = `
                <img src="${img}" onclick="definirPrincipal(${index})" style="cursor:pointer; width:100%; height:100%; object-fit:cover; border-radius:10px;">
                <button class="btn-del" onclick="removerFoto(${index})">X</button>
                ${index === fotoPrincipalIndex ? '<span style="position:absolute; bottom:2px; left:5px; font-size:10px; background:#ffbb00; color:black; padding:2px 5px; border-radius:5px; font-weight:bold;">CAPA</span>' : ''}
            `;
            preview.appendChild(div);
        });
    }

    function definirPrincipal(index) { fotoPrincipalIndex = index; renderizarGaleria(); }

    function removerFoto(index) { 
        listaImagens.splice(index, 1); 
        if (fotoPrincipalIndex >= listaImagens.length) fotoPrincipalIndex = 0;
        renderizarGaleria(); 
    }

    function comprimirImagem(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }

    async function enviarAnuncio() {
        try {
            const marca = document.getElementById('marca').value;
            const modelo = document.getElementById('modelo').value;
            const ano = parseInt(document.getElementById('ano').value);
            const preco = parseFloat(document.getElementById('preco').value);
            const kms = document.getElementById('kms').value;

            if (!marca || !modelo || !ano || !preco) {
                alert("Por favor, preencha Marca, Modelo, Ano e Pre√ßo.");
                return;
            }

            if (listaImagens.length === 0) {
                alert("Adicione pelo menos uma foto.");
                return;
            }

            const btn = document.getElementById('btnPublicar');
            btn.disabled = true;
            btn.innerText = "A guardar...";

            let finalImagens = [...listaImagens];
            if (fotoPrincipalIndex > 0) {
                const principal = finalImagens.splice(fotoPrincipalIndex, 1)[0];
                finalImagens.unshift(principal);
            }

            const dados = {
                vendedorEmail: localStorage.getItem('vendedorEmail'),
                marca, 
                modelo, 
                ano, 
                kms,
                combustivel: document.getElementById('combustivel').value,
                caixa: document.getElementById('caixa').value,
                cor: document.getElementById('cor').value,
                preco,
                imagens: JSON.stringify(finalImagens)
            };

            const res = await fetch('https://garmotor.onrender.com/api/veiculos/adicionar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });

            if (res.ok) {
                alert("‚úÖ VE√çCULO PUBLICADO COM SUCESSO!");
                window.location.href = 'Index.html';
            } else {
                const erroTexto = await res.text();
                throw new Error(erroTexto);
            }

        } catch (err) {
            alert("‚ö†Ô∏è Erro ao publicar: " + err.message);
            const btn = document.getElementById('btnPublicar');
            btn.disabled = false;
            btn.innerText = "PUBLICAR NO STOCK";
        }
    }
</script>
</body>
</html>