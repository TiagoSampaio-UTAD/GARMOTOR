<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARMOTOR - Painel de Gestão</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --gold: #c5a021;
            --bg-dark: #0a0a0a;
            --card-gray: #444444;
            --panel-gray: #333333;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Fundo exterior claro como na imagem */
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .dashboard-container { width: 100%; max-width: 1100px; }

        .header { display: flex; justify-content: flex-end; margin-bottom: 30px; }

        /* Botão Novo Veículo */
        .btn-novo {
            background-color: var(--gold);
            color: black;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
        }
        .btn-novo:hover { opacity: 0.9; transform: translateY(-2px); }

        /* STATS GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background-color: var(--card-gray); padding: 25px; border-radius: 20px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-card i { color: rgba(255,255,255,0.3); margin-bottom: 10px; display: block; }
        .stat-value { font-size: 28px; font-weight: 800; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }

        /* LISTA PRINCIPAL */
        .main-panel { background-color: var(--panel-gray); border-radius: 25px; padding: 40px; color: white; min-height: 400px; }
        .panel-title { font-size: 20px; font-weight: 700; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .vehicle-list { display: flex; flex-direction: column; gap: 15px; }

        /* CARD DO VEÍCULO */
        .vehicle-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: 0.2s;
        }
        .vehicle-item:hover { background-color: rgba(255, 255, 255, 0.08); border-color: var(--gold); }

        .vehicle-img { width: 85px; height: 60px; border-radius: 10px; object-fit: cover; background: #222; }

        .vehicle-content { flex: 1; }
        .vehicle-header { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
        .vehicle-name { font-size: 16px; font-weight: 700; margin: 0; }

        .badge { font-size: 9px; padding: 3px 10px; border-radius: 6px; font-weight: 800; text-transform: uppercase; border: 1px solid; }
        .badge-disponivel { color: #34d399; border-color: rgba(52, 211, 153, 0.3); background: rgba(52, 211, 153, 0.1); }
        .badge-reservado { color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); background: rgba(251, 191, 36, 0.1); }
        .badge-vendido { color: #f87171; border-color: rgba(248, 113, 113, 0.3); background: rgba(248, 113, 113, 0.1); }

        .vehicle-details { font-size: 13px; color: rgba(255,255,255,0.4); }

        /* AÇÕES (Botões) */
        .actions { display: flex; gap: 15px; }
        .btn-action { 
            background: none; border: none; color: rgba(255,255,255,0.3); 
            cursor: pointer; transition: 0.2s; padding: 5px;
        }
        .btn-action:hover { color: white; transform: scale(1.1); }
        .btn-delete:hover { color: #f87171; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <a href="AdicionarVeiculo.html" class="btn-novo">
            <i data-lucide="plus"></i> Novo Veículo
        </a>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <i data-lucide="package" size="20"></i>
            <span class="stat-value" id="st-total">0</span>
            <span class="stat-label">Total em Stock</span>
        </div>
        <div class="stat-card">
            <i data-lucide="car" size="20"></i>
            <span class="stat-value" id="st-disp">0</span>
            <span class="stat-label">Disponíveis</span>
        </div>
        <div class="stat-card">
            <i data-lucide="trending-up" size="20"></i>
            <span class="stat-value" id="st-res">0</span>
            <span class="stat-label">Reservados</span>
        </div>
        <div class="stat-card">
            <i data-lucide="dollar-sign" size="20"></i>
            <span class="stat-value" id="st-val">0 €</span>
            <span class="stat-label">Valor Total</span>
        </div>
    </div>

    <div class="main-panel">
        <div class="panel-title">Anúncios Ativos (<span id="count-anuncios">0</span>)</div>
        <div id="vehicle-list" class="vehicle-list">
            </div>
    </div>
</div>

<script>
    // Inicializa os ícones do Lucide
    lucide.createIcons();

    // Rota definida no seu server.js
    const API_URL = "/api/veiculos"; 

    async function loadDashboard() {
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error("Erro ao aceder à API");
            const veiculos = await res.json();

            // 1. Atualizar Estatísticas
            document.getElementById('st-total').innerText = veiculos.length;
            document.getElementById('count-anuncios').innerText = veiculos.length;
            
            const disp = veiculos.filter(v => (v.estado || '').toLowerCase() === 'disponível' || !v.estado).length;
            document.getElementById('st-disp').innerText = disp;
            
            const reser = veiculos.filter(v => (v.estado || '').toLowerCase() === 'reservado').length;
            document.getElementById('st-res').innerText = reser;

            const totalPreco = veiculos.reduce((acc, v) => acc + Number(v.preco || 0), 0);
            document.getElementById('st-val').innerText = totalPreco.toLocaleString('pt-PT') + " €";

            // 2. Renderizar Lista de Veículos
            const listContainer = document.getElementById('vehicle-list');
            
            if (veiculos.length === 0) {
                listContainer.innerHTML = "<p style='color:rgba(255,255,255,0.3)'>Nenhum veículo encontrado.</p>";
                return;
            }

            listContainer.innerHTML = veiculos.map(v => {
                // Trata a imagemcapa do seu SQL (pega a primeira antes do |||)
                const imgUrl = v.imagemcapa ? v.imagemcapa.split('|||')[0] : '';
                const estado = v.estado || 'Disponível';
                const badgeClass = `badge-${estado.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")}`;

                return `
                    <div class="vehicle-item">
                        <img src="${imgUrl}" class="vehicle-img" onerror="this.src='https://via.placeholder.com/90x60?text=Garmotor'">
                        <div class="vehicle-content">
                            <div class="vehicle-header">
                                <h4 class="vehicle-name">${v.marca} ${v.modelo}</h4>
                                <span class="badge ${badgeClass}">${estado.toUpperCase()}</span>
                            </div>
                            <div class="vehicle-details">
                                ${Number(v.preco).toLocaleString('pt-PT')} € · ${v.ano} · ${Number(v.kms).toLocaleString()} km · ${v.combustivel || 'N/D'}
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn-action" onclick="editarVeiculo(${v.id})" title="Editar">
                                <i data-lucide="pencil" size="18"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="eliminarVeiculo(${v.id})" title="Eliminar">
                                <i data-lucide="trash-2" size="18"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons(); // Recarrega ícones após gerar HTML
        } catch (err) {
            console.error("Erro no Dashboard:", err);
        }
    }

    // Função para Eliminar (Conecta ao seu DELETE /api/veiculos/:id)
    async function eliminarVeiculo(id) {
        if (!confirm("Tem a certeza que deseja eliminar este anúncio permanentemente?")) return;

        try {
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadDashboard(); // Recarrega a lista
            } else {
                alert("Erro ao eliminar o veículo.");
            }
        } catch (err) {
            alert("Erro de ligação ao servidor.");
        }
    }

    // Função para Editar (Redireciona)
    function editarVeiculo(id) {
        window.location.href = `EditarVeiculo.html?id=${id}`;
    }

    window.onload = loadDashboard;
</script>
</body>
</html>